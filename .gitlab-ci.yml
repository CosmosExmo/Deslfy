image: golang:alpine

stages:
  - Test
  - Build

db_create_test:
  stage: Test
  services:
    - postgres:15.3-alpine3.18
  variables:
    POSTGRES_DB: deslfy
    POSTGRES_USER: root
    POSTGRES_PASSWORD: secret
    POSTGRES_PORT: 5432
    POSTGRES_HOST_AUTH_METHOD: trust
    TZ: Europe/Istanbul
  before_script:
    - apk add --update curl && rm -rf /var/cache/apk/*
    - apk add --no-cache make
  script:
    - echo "Database service started"
    - curl -L https://github.com/golang-migrate/migrate/releases/download/v4.16.1/migrate.linux-amd64.tar.gz | tar xvz
    - mv migrate /usr/bin/migrate
    - which migrate
    - make migrateup
    - make test
  tags:
    - deploy-runner
  when: manual

build_image:
  stage: Build
  image: 23.0.0-alpine3.17
  services:
    - name: docker:23.0.0-dind
      alias: docker
  script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER $CI_REGISTRY --password-stdin
    - docker compose up --build
    - docker push $CI_REGISTRY_IMAGE
  tags:
    - deploy-runner
  when: manual
